<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Paste</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* ── Layout ── */
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    h1 {
      font-size: 1.8rem;
      font-weight: 300;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #c8a96e;
      margin-bottom: 0.3rem;
    }
    .subtitle {
      color: #555;
      font-size: 0.85rem;
      margin-bottom: 1.5rem;
    }

    /* ── Token Setup ── */
    .token-bar {
      background: #12121a;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    .token-bar.connected {
      border-color: #2a4a2a;
      background: #0e1510;
    }
    .token-bar summary {
      cursor: pointer;
      color: #888;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .token-bar summary::-webkit-details-marker { display: none; }
    .token-bar summary .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e07a5f;
      flex-shrink: 0;
    }
    .token-bar.connected summary .dot { background: #6ecf6e; }
    .token-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.8rem;
      align-items: center;
    }
    .token-row input {
      flex: 1;
      padding: 0.5rem 0.8rem;
      background: #0a0a0f;
      border: 1px solid #1e1e30;
      border-radius: 5px;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 0.8rem;
      outline: none;
    }
    .token-row input:focus { border-color: #c8a96e; }
    .token-help {
      color: #555;
      font-size: 0.78rem;
      margin-top: 0.5rem;
      line-height: 1.5;
    }
    .token-help a { color: #c8a96e; }

    /* ── Drop Zone ── */
    .dropzone {
      border: 2px dashed #1e1e30;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .dropzone:hover, .dropzone.dragover {
      border-color: #c8a96e;
      background: rgba(200, 169, 110, 0.04);
    }
    .dropzone .dz-icon {
      font-size: 1.8rem;
      margin-bottom: 0.4rem;
      color: #333;
      transition: color 0.2s;
    }
    .dropzone:hover .dz-icon, .dropzone.dragover .dz-icon { color: #c8a96e; }
    .dropzone .dz-text { color: #555; font-size: 0.85rem; }
    .dropzone .dz-text strong { color: #c8a96e; }
    .dropzone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .dz-filename {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #c8a96e;
      display: none;
    }
    .dz-filename.show { display: block; }

    /* ── Textarea ── */
    textarea {
      width: 100%;
      height: 50vh;
      background: #0e0e16;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      color: #d4d4d4;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.85rem;
      padding: 1rem;
      resize: vertical;
      outline: none;
      tab-size: 2;
      line-height: 1.5;
    }
    textarea:focus { border-color: #c8a96e; }
    textarea::placeholder { color: #333; }

    /* ── Buttons ── */
    .actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    button {
      padding: 0.6rem 1.4rem;
      border: 1px solid #1e1e30;
      border-radius: 6px;
      background: #12121a;
      color: #e0e0e0;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    button:hover { border-color: #c8a96e; color: #c8a96e; }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    button:disabled:hover { border-color: #1e1e30; color: #e0e0e0; }
    button.primary {
      background: #c8a96e;
      color: #0a0a0f;
      border-color: #c8a96e;
      font-weight: 600;
    }
    button.primary:hover { background: #d4b97a; }
    button.primary:disabled { background: #5a4d35; border-color: #5a4d35; }
    button.primary:disabled:hover { background: #5a4d35; color: #0a0a0f; }

    /* ── Status / Output ── */
    .status {
      margin-top: 1rem;
      font-size: 0.85rem;
      min-height: 1.2em;
    }
    .status.error { color: #e07a5f; }
    .status.success { color: #6ecf6e; }
    .status.working { color: #c8a96e; }

    .link-output {
      margin-top: 0.8rem;
      display: none;
    }
    .link-output.show { display: block; }
    .link-box {
      background: #0e0e16;
      border: 1px solid #1e1e30;
      border-radius: 6px;
      padding: 0.8rem 1rem;
      font-family: monospace;
      font-size: 0.85rem;
      color: #c8a96e;
      word-break: break-all;
      line-height: 1.4;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .link-box:hover { border-color: #c8a96e; }
    .link-url { flex: 1; }
    .link-box .badge {
      background: #c8a96e;
      color: #0a0a0f;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .link-box .badge.show { opacity: 1; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Canvas Paste</h1>
    <p class="subtitle">Paste or upload HTML. Publish to get a permanent shareable link.</p>

    <!-- Token Setup -->
    <details class="token-bar" id="tokenBar">
      <summary>
        <span class="dot"></span>
        <span id="tokenStatus">Not connected — GitHub token needed to publish</span>
      </summary>
      <div class="token-row">
        <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
        <button onclick="saveToken()">Save</button>
        <button onclick="clearToken()">Clear</button>
      </div>
      <p class="token-help">
        Create a <a href="https://github.com/settings/tokens?type=beta" target="_blank">fine-grained token</a>
        with <strong>Contents: Read &amp; Write</strong> permission on <strong>FAeN399.github.io</strong> only.
      </p>
    </details>

    <!-- Drop Zone -->
    <div class="dropzone" id="dropzone">
      <input type="file" id="fileInput" accept=".html,.htm,.txt,.svg,.xml">
      <div class="dz-icon">&#8593;</div>
      <div class="dz-text">Drop an HTML file here or <strong>click to browse</strong></div>
      <div class="dz-filename" id="dzFilename"></div>
    </div>

    <!-- Editor -->
    <textarea id="code" placeholder="Paste your HTML here..." spellcheck="false"></textarea>

    <!-- Actions -->
    <div class="actions">
      <button class="primary" id="publishBtn" onclick="publish()" disabled>Publish</button>
      <button onclick="preview()">Preview</button>
    </div>

    <!-- Status -->
    <div class="status" id="status"></div>

    <!-- Link Output -->
    <div class="link-output" id="linkOutput">
      <div class="link-box" onclick="copyLink()">
        <span class="link-url" id="linkText"></span>
        <span class="badge" id="copiedBadge">Copied!</span>
      </div>
    </div>
  </div>

  <script>
    // ── Config ──
    var REPO = 'FAeN399/FAeN399.github.io';
    var BRANCH = 'main';
    var PATH_PREFIX = 'canvas/p/';
    var PAGES_BASE = 'https://faen399.github.io/canvas/p/';
    var API = 'https://api.github.com';
    var currentLink = '';

    // ── Token Management ──
    function getToken() {
      return localStorage.getItem('canvas_gh_token') || '';
    }

    function saveToken() {
      var t = document.getElementById('tokenInput').value.trim();
      if (!t) return;
      localStorage.setItem('canvas_gh_token', t);
      document.getElementById('tokenInput').value = '';
      updateTokenUI();
      testToken(t);
    }

    function clearToken() {
      localStorage.removeItem('canvas_gh_token');
      updateTokenUI();
    }

    function updateTokenUI() {
      var bar = document.getElementById('tokenBar');
      var status = document.getElementById('tokenStatus');
      var btn = document.getElementById('publishBtn');
      if (getToken()) {
        bar.classList.add('connected');
        status.textContent = 'Connected to GitHub';
        btn.disabled = false;
      } else {
        bar.classList.remove('connected');
        status.textContent = 'Not connected — GitHub token needed to publish';
        btn.disabled = true;
        bar.open = true;
      }
    }

    async function testToken(token) {
      try {
        var r = await fetch(API + '/repos/' + REPO, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!r.ok) throw new Error('Token rejected');
        setStatus('Token verified', 'success');
      } catch (e) {
        setStatus('Token invalid — check permissions', 'error');
        clearToken();
      }
    }

    // ── Status ──
    function setStatus(msg, type) {
      var el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status' + (type ? ' ' + type : '');
    }

    // ── Generate Short ID ──
    function shortId() {
      var chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      var id = '';
      var arr = crypto.getRandomValues(new Uint8Array(7));
      for (var i = 0; i < 7; i++) id += chars[arr[i] % chars.length];
      return id;
    }

    // ── Publish to GitHub ──
    async function publish() {
      var code = document.getElementById('code').value;
      if (!code.trim()) { setStatus('Nothing to publish', 'error'); return; }

      var token = getToken();
      if (!token) { setStatus('Set up your GitHub token first', 'error'); return; }

      var btn = document.getElementById('publishBtn');
      btn.disabled = true;
      setStatus('Publishing...', 'working');

      var filename = shortId() + '.html';
      var path = PATH_PREFIX + filename;

      try {
        var r = await fetch(API + '/repos/' + REPO + '/contents/' + path, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: 'canvas: ' + filename,
            content: btoa(unescape(encodeURIComponent(code))),
            branch: BRANCH
          })
        });

        if (!r.ok) {
          var err = await r.json();
          throw new Error(err.message || 'Upload failed');
        }

        currentLink = PAGES_BASE + filename;
        document.getElementById('linkText').textContent = currentLink;
        document.getElementById('linkOutput').classList.add('show');
        setStatus('Published! Pages deploys in ~30s.', 'success');
      } catch (e) {
        setStatus('Error: ' + e.message, 'error');
      }

      btn.disabled = false;
    }

    // ── Copy Link ──
    function copyLink() {
      navigator.clipboard.writeText(currentLink).then(function() {
        var badge = document.getElementById('copiedBadge');
        badge.classList.add('show');
        setTimeout(function() { badge.classList.remove('show'); }, 1500);
      });
    }

    // ── Preview ──
    function preview() {
      var code = document.getElementById('code').value;
      if (!code.trim()) return;
      var w = window.open('', '_blank');
      w.document.open();
      w.document.write(code);
      w.document.close();
    }

    // ── File Upload ──
    function handleFile(file) {
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(e) {
        var content = e.target.result;
        document.getElementById('code').value = content;
        var nameEl = document.getElementById('dzFilename');
        nameEl.textContent = 'Loaded: ' + file.name + ' (' + (content.length / 1024).toFixed(1) + ' KB)';
        nameEl.classList.add('show');
      };
      reader.readAsText(file);
    }

    // ── Init ──
    document.addEventListener('DOMContentLoaded', function() {
      updateTokenUI();

      // File input
      document.getElementById('fileInput').addEventListener('change', function(e) {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
      });

      // Drag and drop
      var dz = document.getElementById('dropzone');
      dz.addEventListener('dragover', function(e) { e.preventDefault(); dz.classList.add('dragover'); });
      dz.addEventListener('dragleave', function() { dz.classList.remove('dragover'); });
      dz.addEventListener('drop', function(e) {
        e.preventDefault();
        dz.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
      });

      // Tab key
      document.getElementById('code').addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          e.preventDefault();
          var s = this.selectionStart, end = this.selectionEnd;
          this.value = this.value.substring(0, s) + '  ' + this.value.substring(end);
          this.selectionStart = this.selectionEnd = s + 2;
        }
      });
    });
  </script>
</body>
</html>
